{% extends "base.html" %}

{% block title %}Anime Library{% endblock %}

{% block content %}
<style>
    .search-and-filter-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
        background: var(--card-background);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    .search-and-filter-bar .form-group {
        flex-grow: 1;
        margin-bottom: 0;
    }
    .search-and-filter-bar input, .search-and-filter-bar select {
        width: 100%;
    }
    .anime-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1.5rem;
    }
    .anime-poster {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background-color: #202030;
        text-decoration: none;
        color: white;
    }
    .anime-poster:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 25px rgba(0, 170, 255, 0.5);
    }
    .anime-poster img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
    .poster-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
        padding: 2rem 1rem 1rem 1rem;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
    }
    .poster-title {
        font-weight: bold;
    }
    .poster-rating {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.9rem;
        background: rgba(0,0,0,0.7);
        padding: 0.25rem 0.5rem;
        border-radius: 5px;
    }
    .poster-rating .fa-star {
        color: #ffc107;
    }
</style>

<section class="card glass-effect" id="anime">
    <div class="card-header">
        <h2><i class="fas fa-tv"></i> Anime Library</h2>
        {% if session.get('is_master') %}
        <button class="btn-primary" onclick="openModal('addSeriesModal')"><i class="fas fa-plus"></i> Add New Series</button>
        {% endif %}
    </div>
    <div class="card-content">
        <!-- Search and Filter Form -->
        <form method="GET" action="{{ url_for('anime') }}" class="search-and-filter-bar">
            <div class="form-group">
                <input type="search" name="query" placeholder="Search for an anime..." value="{{ query or '' }}">
            </div>
            <div class="form-group">
                <select name="genre" onchange="this.form.submit()">
                    <option value="">All Genres</option>
                    {% for genre in genres %}
                    <option value="{{ genre.name }}" {% if genre.name == genre_filter %}selected{% endif %}>{{ genre.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn-primary">Search</button>
        </form>

        <div class="anime-grid">
            {% for item in series_list_with_ratings %}
            <a href="{{ url_for('anime_series_details', series_id=item.series.id) }}" class="anime-poster">
                <img src="{{ item.series.image_url or 'https://placehold.co/400x600/0c0c1e/e0e0e0?text=' ~ item.series.title|replace(' ', '+') }}" alt="{{ item.series.title }} Poster" referrerpolicy="no-referrer">
                <div class="poster-overlay">
                    <h4 class="poster-title">{{ item.series.title }}</h4>
                    <div class="poster-rating">
                        <i class="fas fa-star"></i> {{ item.avg_rating if item.avg_rating > 0 else 'N/A' }}
                    </div>
                </div>
            </a>
            {% else %}
            <p>No anime series found. Try adjusting your search or filters.</p>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Add Series Modal (Master Only) -->
{% if session.get('is_master') %}
<div id="addSeriesModal" class="modal">
    <div class="modal-content glass-effect">
        <span class="close-btn" onclick="closeModal('addSeriesModal')">&times;</span>
        <h2>Add New Anime Series</h2>
        <form action="{{ url_for('add_anime_series') }}" method="POST">
            <div class="form-group">
                <label>Series Title</label>
                <input type="text" name="title" required>
            </div>
            <div class="form-group">
                <label>Poster Image URL</label>
                <input type="url" name="image_url" placeholder="https://.../poster.jpg">
            </div>
            <div class="form-group">
                <label>Genres (Hold Ctrl/Cmd to select multiple)</label>
                <select name="genres" multiple style="height: 150px;">
                    {% for genre in genres %}
                    <option value="{{ genre.id }}">{{ genre.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn-primary">Save Series</button>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}
