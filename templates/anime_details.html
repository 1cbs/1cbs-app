{% extends "base.html" %}

{% block title %}{{ series.title }}{% endblock %}

{% block content %}
<style>
    .series-header {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    .series-poster-container {
        flex-shrink: 0;
        width: 200px;
    }
    .series-poster-container img {
        width: 100%;
        border-radius: 8px;
    }
    .series-info {
        flex-grow: 1;
    }
    .series-info h2 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
    .series-genres {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    .genre-tag {
        background: var(--primary-color);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.9rem;
    }
    .rating-container {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .avg-rating {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.2rem;
    }
    .avg-rating .fa-star {
        color: #ffc107;
    }
    /* Star Rating Input */
    .star-rating {
        display: inline-flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
    }
    .star-rating input { display: none; }
    .star-rating label {
        font-size: 1.5rem;
        color: #444;
        cursor: pointer;
        transition: color 0.2s;
    }
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
        color: #ffc107;
    }
</style>

<section class="card glass-effect" id="anime-details">
    <div class="card-content">
        <div class="series-header">
            <div class="series-poster-container">
                <img src="{{ series.image_url or 'https://placehold.co/400x600/0c0c1e/e0e0e0?text=' ~ series.title|replace(' ', '+') }}" alt="{{ series.title }} Poster" referrerpolicy="no-referrer">
            </div>
            <div class="series-info">
                <a href="{{ url_for('anime') }}" class="btn-icon" style="margin-bottom: 1rem;"><i class="fas fa-arrow-left"></i> Back to Library</a>
                <h2>{{ series.title }}</h2>
                <div class="series-genres">
                    {% for genre in series.genres %}
                    <span class="genre-tag">{{ genre.name }}</span>
                    {% endfor %}
                </div>
                <div class="rating-container">
                    <div class="avg-rating">
                        <i class="fas fa-star"></i> <span id="avg-rating-display">{{ avg_rating if avg_rating > 0 else 'N/A' }}</span>
                    </div>
                    {% if 'user_id' in session %}
                    <div class="user-rating">
                        <form id="rating-form">
                            <div class="star-rating">
                                <input type="radio" id="star5" name="rating" value="5" {% if user_rating == 5 %}checked{% endif %}><label for="star5" title="5 stars">★</label>
                                <input type="radio" id="star4" name="rating" value="4" {% if user_rating == 4 %}checked{% endif %}><label for="star4" title="4 stars">★</label>
                                <input type="radio" id="star3" name="rating" value="3" {% if user_rating == 3 %}checked{% endif %}><label for="star3" title="3 stars">★</label>
                                <input type="radio" id="star2" name="rating" value="2" {% if user_rating == 2 %}checked{% endif %}><label for="star2" title="2 stars">★</label>
                                <input type="radio" id="star1" name="rating" value="1" {% if user_rating == 1 %}checked{% endif %}><label for="star1" title="1 star">★</label>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <hr style="border-color: var(--border-color); margin: 2rem 0;">

        <div class="episodes-list">
            <div class="card-header" style="padding: 0 0 1rem 0;">
                <h3>Episodes</h3>
                {% if session.get('is_master') %}
                <button class="btn-primary" onclick="openModal('addEpisodeModal')"><i class="fas fa-plus"></i> Add Episode</button>
                {% endif %}
            </div>
            <ul class="item-list">
                {% for episode in episodes %}
                <li>
                    <span class="item-name"><i class="fas fa-film"></i> {{ episode.title }}</span>
                    <div class="item-actions">
                        <button class="btn-icon" onclick="openModal('videoPlayerModal', '{{ episode.url }}')"><i class="fas fa-play"></i></button>
                        {% if 'user_id' in session %}
                        <form action="{{ url_for('create_watch_party') }}" method="POST" style="display: inline;">
                            <input type="hidden" name="video_selection" value="anime-{{ episode.id }}">
                            <button type="submit" class="btn-icon" title="Start a Watch Party"><i class="fas fa-users"></i></button>
                        </form>
                        {% endif %}
                        {% if session.get('is_master') %}
                        <form action="{{ url_for('delete_anime_episode', id=episode.id) }}" method="POST" style="display: inline;">
                            <button type="submit" class="btn-icon btn-delete"><i class="fas fa-trash"></i></button>
                        </form>
                        {% endif %}
                    </div>
                </li>
                {% else %}
                <li>No episodes added yet.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</section>

<!-- Add Episode Modal (Master Only) -->
{% if session.get('is_master') %}
<div id="addEpisodeModal" class="modal">
    <div class="modal-content glass-effect">
        <span class="close-btn" onclick="closeModal('addEpisodeModal')">&times;</span>
        <h2>Add Episode to "{{ series.title }}"</h2>
        <form action="{{ url_for('add_anime_episode', series_id=series.id) }}" method="POST">
            <div class="form-group">
                <label>Episode Title</label>
                <input type="text" name="title" required>
            </div>
            <div class="form-group">
                <label>Direct Video URL</label>
                <input type="url" name="url" required>
            </div>
            <button type="submit" class="btn-primary">Save Episode</button>
        </form>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ratingForm = document.getElementById('rating-form');
    if (ratingForm) {
        ratingForm.addEventListener('change', function(e) {
            const stars = e.target.value;
            fetch("{{ url_for('rate_series', series_id=series.id) }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'stars=' + stars
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('avg-rating-display').textContent = data.new_avg_rating;
                }
            });
        });
    }
});
</script>
{% endblock %}
